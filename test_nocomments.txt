def processPercentLine(line):
    if not hasattr(processPercentLine, "inBlock"):
        processPercentLine.inBlock = False
    if processPercentLine.inBlock:
        end = line.find("%}")
        if end == -1:
            return ""
        processPercentLine.inBlock = False
        return processPercentLine(line[end + 2:])
    start = line.find("%{")
    if start != -1:
        end = line.find("%}", start + 2)
        if end == -1:
            processPercentLine.inBlock = True
            return line[:start].rstrip() + ("\n" if line[:start].strip() else "")
        else:
            cleaned = line[:start] + line[end + 2:]
            return processPercentLine(cleaned)
    idx = line.find("%")
    if idx != -1:
        code = line[:idx].rstrip()
        return code + ("\n" if code else "")
    return line
